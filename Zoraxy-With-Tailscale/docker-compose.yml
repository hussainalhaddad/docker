# In Zoraxy SSO, configure the forward auth to point to: http://tinyauth:3000/api/auth/traefik
# and then add a HTTP proxy (e.g. auth.example.com) to point to tinyauth:3000

# To create a user in Tinyuth, run the below command:
# docker run -i -t --rm ghcr.io/steveiliop56/tinyauth:latest user create --interactive
# Copy the output to the variable USERS in the .env file

# Also enable TOTP with this command:
# docker run -i -t --rm ghcr.io/steveiliop56/tinyauth:latest totp generate --interactive


# Stream proxy ports must be add the ports section under tailscale service for them to work    
# You may remove port 8000 once you create a HTTP proxy (e.g. console.example.com) pointing to tailscale:8000

x-common: &common-options
  restart: always
  env_file: .env
  
services:
  tailscale:
    <<: *common-options
    image: tailscale/tailscale:latest
    container_name: tailscale
    ports:
      - 80:80
      - 443:443
      - 8000:8000
    environment:
      - TS_EXTRA_ARGS=--accept-routes
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - ts-state:/var/lib/tailscale
      - /etc/localtime:/etc/localtime:ro
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      
  zoraxy:
    <<: *common-options
    image: zoraxydocker/zoraxy:latest
    container_name: zoraxy
    network_mode: service:tailscale
    volumes:
      - zoraxy-config:/opt/zoraxy/config/
      - zoraxy-plugin:/opt/zoraxy/plugin/
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - tailscale
      
  tinyauth:
    <<: *common-options
    image: ghcr.io/steveiliop56/tinyauth:latest
    container_name: tinyauth
    volumes:
      - /etc/localtime:/etc/localtime:ro    
    depends_on:
      - zoraxy      
volumes:
  ts-state:
  zoraxy-config:
  zoraxy-plugin:
